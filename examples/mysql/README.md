
# What have we here?

This directory contains a small standalone example for using db_extractor with
mysql.

# Quick Start

## Place this code under your site's docroot somewhere.

> cd /path/to/docroot
>
> git clone https://github.com/dan-da/db_extractor.git

note: only the auto-generated files inside db_crud directory need to be
webserver accessible. If you don't plan to use the crud functionality, then the
files can be anywhere.

## Check DB config

> vi ./sql/init_db_params.sh


Modify parameters as needed for your DB. It may work out of the box for
localhost.

## Create example Database.

> ./sql/create_db.sh


## Generate DB Model


> ./gen_dbmodel.sh

 
This will run db_extractor and generate the following directories:

* db_model : contains model classes for interacting with DB.
* db_crud : contains server and client code for basic create, update, delete
 
You may wish to explore these directories at this point and browse the
auto-generated code.


## Modify DB Schema.

Add a column to a table. whatever you like.

> vi sql/schema.sql      [ add a column, eg to user table. ]

then recreate the db.

> ./sql/recreate_db.sh

and re-generate the data model.

> ./gen_dbmodel.sh
 
At this point, if you check the db_model files representing the table you
modified you will see it has the new column.

## View the CRUD.


In your web browser navigate to:
>  http://yoursite/path/to/db_extractor/examples/mysql/db_crud/client/user.html
  
There you should see a dynamic grid representing the user table.
You can add, edit, or delete rows.  Also notice that paging and searching
are supported.

An html page has been created for each table or view in the sample DB.  If your
webserver allows viewing directories, then you can just load:
>  http://yoursite/path/to/db_extractor/examples/mysql/db_crud/client/user.html

Many (most?) applications will use the db_model only and will not need the
crud.  But you may find it a handy admin tool for viewing/updating tables, or
as a starting point for end-user functionality.

## Write a simple database application using the db_model classes.

paste the following into a file called "demo.php" and run it.

```php
<?php

require_once( dirname(__FILE__) . "/db_model/dbFactory.php" );

// Let's create, update, retrieve, and then delete a User row.

$dto_user = dbFactory::dbmf()->dtoNew( 'user' );

// populate the new record.
$dto_user->user_id = null;    // leave the PK blank, so it will be auto-generated by db.
$dto_user->username = 'santaclaus';
$dto_user->email = 'nick@northpole.com';
$dto_user->fname = 'Santa';
$dto_user->lname = 'Claus';
$dto_user->password_hash = md5( 'some secret' );

$dao_user = dbFactory::dbmf()->daoInstance( 'user' );

// 1. Create.
$id = $dao_user->insert( $dto_user );
// $dao_user->save( $dto_user );  // we could also call save, but would not get $id back

// note: $dto_user->user_id has been set now.

// Now let's modify a column.
$dto_user->email = 'santaclaus@northpole.com';

// 2. Update.  (It will be an update because PK user_id is specified.)
$dao_user->save( $dto_user );
// $dao_user->update( $dto_user );  // we could also call update directly.

// 3. Query the record.
$dto_user = $dao_user->getByPk( $id );
print_r( $dto_user );

// 4. Delete. 
$dao_user->delete( $dto_user );

```

Output should look similar to:

```
user_dto Object
(
    [user_id] => 3
    [username] => santaclaus
    [email] => santaclaus@northpole.com
    [password_hash] => 689f843c767642541d62a2289f764524
    [fname] => Santa
    [lname] => Claus
)
```

## Perform some queries using the DaoCriteria class.

paste the following into a file called "criteria.php" and run it.

```php
<?php

require_once( dirname(__FILE__) . "/db_model/dbFactory.php");

$dao_ugv = dbFactory::dbmf()->daoInstance( 'user_group_view' );


// ## query 1:  All users

$criteria = dbFactory::dbmf()->daoCriteriaNew();  // empty criteria object.
$rows = $dao_ugv->getByCriteria( $criteria );
print_results( $dao_ugv, $rows );

// note:  we could have called $dao_ugv->getAll() instead.

// ## query 2:  where username = 'sam' or email like %gmail.com%

$criteria = dbFactory::dbmf()->daoCriteriaNew()->
                eq( 'username', 'sam' )->
                or_()->
                like( 'email', '%gmail.com%' );
                
$rows = $dao_ugv->getByCriteria( $criteria );
print_results( $dao_ugv, $rows );


// ## query 3:  where username = 'sam' or email like %gmail.com% order by username, limit 2 offset 1

$criteria = dbFactory::dbmf()->daoCriteriaNew()->
                eq( 'username', 'sam' )->
                or_()->
                like( 'email', '%gmail.com%' )->
                orderBy('username')->
                limit(2)->
                offset(1);
                
$rows = $dao_ugv->getByCriteria( $criteria );
print_results( $dao_ugv, $rows );


// ## query 4:  where (username = 'jim' or email not like %gmail.com%) and lname = ''

$criteria = dbFactory::dbmf()->daoCriteriaNew()->
                lparen()->
                eq( 'username', 'jim' )->
                or_()->
                notLike('email', '%gmail.com')->
                rparen()->
                and_()->
                eq( 'fname', 'White');
                
$rows = $dao_ugv->getByCriteria( $criteria );
print_results( $dao_ugv, $rows );


// ## query 5:  where user_id in (1,2) and groupname is 'HelpDesk' order by user_name

$criteria = dbFactory::dbmf()->daoCriteriaNew()->
                in( 'user_id', range(1,2) )->
                and_()->
                eq( 'groupname', 'HelpDesk' )->
                orderBy('username');
                
$rows = $dao_ugv->getByCriteria( $criteria );
print_results( $dao_ugv, $rows );

function print_results( $dao, $rows ) {
    echo "=======\n";
    echo "SQL: " . $dao->last_query() . "\n";
    print_r( $rows );
    echo "=======\n\n";
}
```

Output should look similar to:

```
=======
SQL: select * from "user_group_view"     
Array
(
    [0] => user_group_view_dto Object
        (
            [user_id] => 1
            [username] => jim
            [email] => jim@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Jim
            [lname] => White
            [group_id] => 1
            [groupname] => Administrator
        )

    [1] => user_group_view_dto Object
        (
            [user_id] => 1
            [username] => jim
            [email] => jim@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Jim
            [lname] => White
            [group_id] => 2
            [groupname] => HelpDesk
        )

    [2] => user_group_view_dto Object
        (
            [user_id] => 2
            [username] => sally
            [email] => sally@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Sally
            [lname] => Maplethorpe
            [group_id] => 3
            [groupname] => Customer
        )

)
=======

=======
SQL: select * from "user_group_view" where "username" = 'sam' or "email" like '%gmail.com%'    
Array
(
    [0] => user_group_view_dto Object
        (
            [user_id] => 1
            [username] => jim
            [email] => jim@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Jim
            [lname] => White
            [group_id] => 1
            [groupname] => Administrator
        )

    [1] => user_group_view_dto Object
        (
            [user_id] => 1
            [username] => jim
            [email] => jim@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Jim
            [lname] => White
            [group_id] => 2
            [groupname] => HelpDesk
        )

    [2] => user_group_view_dto Object
        (
            [user_id] => 2
            [username] => sally
            [email] => sally@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Sally
            [lname] => Maplethorpe
            [group_id] => 3
            [groupname] => Customer
        )

)
=======

=======
SQL: select * from "user_group_view" where "username" = 'sam' or "email" like '%gmail.com%'  order by "username" asc limit 2 offset 1
Array
(
    [0] => user_group_view_dto Object
        (
            [user_id] => 1
            [username] => jim
            [email] => jim@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Jim
            [lname] => White
            [group_id] => 2
            [groupname] => HelpDesk
        )

    [1] => user_group_view_dto Object
        (
            [user_id] => 2
            [username] => sally
            [email] => sally@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Sally
            [lname] => Maplethorpe
            [group_id] => 3
            [groupname] => Customer
        )

)
=======

=======
SQL: select * from "user_group_view" where ( "username" = 'jim' or "email" not like '%gmail.com' ) and "fname" = 'White'    
Array
(
)
=======

=======
SQL: select * from "user_group_view" where "user_id" in ('1', '2') and "groupname" = 'HelpDesk'  order by "username" asc  
Array
(
    [0] => user_group_view_dto Object
        (
            [user_id] => 1
            [username] => jim
            [email] => jim@gmail.com
            [password_hash] => asdfasdfasdfasdfdsaf
            [fname] => Jim
            [lname] => White
            [group_id] => 2
            [groupname] => HelpDesk
        )

)
=======
```
